<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Portal Login</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #F3F4F6; margin: 0; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        h1 { color: #4F46E5; margin-bottom: 10px; }
        p { color: #6B7280; margin-bottom: 30px; }
        .error-box { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 6px; margin-top: 20px; display: none; font-size: 14px; text-align: left; }
        .loader { display: none; margin-top: 20px; color: #4F46E5; font-weight: 600; }
        
        /* Center the Google Button */
        .g_id_signin { display: flex; justify-content: center; margin-top: 20px; }
    </style>
</head>
<body>

<div class="login-card">
    <h1>Campaign Portal</h1>
    <p>Sign in to access the request form.</p>
    
    <div id="g_id_onload"
         data-client_id="682330426868-1eh7atq76uv1g872nsehf45rgj9p5hvd.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="continue_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>

    <div class="loader" id="loader">Verifying Access with System...</div>
    <div class="error-box" id="errorMsg"></div>
</div>

<script>
    // --- 3. CONFIGURATION ---
    // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    const SCRIPT_URL = 'https://script.google.com/a/macros/themindshare.in/s/AKfycbzAQaVDC78ka0nPH426GYpS7Dyq-KDZ0nuUaCo11e6eHS-57X_WMAwJ3-3CxQ53gzYH/exec'; 

    // --- 4. HANDLE GOOGLE RESPONSE ---
    function handleCredentialResponse(response) {
        // Decode the JWT token to get user info
        const responsePayload = decodeJwtResponse(response.credential);
        const email = responsePayload.email;

        console.log("Google Email Detected: " + email);
        verifyAccessWithSheet(email);
    }

    // --- 5. JWT DECODER HELPER ---
    function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    // --- 6. VERIFY WITH YOUR GOOGLE SHEET ---
    function verifyAccessWithSheet(email) {
        const loader = document.getElementById('loader');
        const errBox = document.getElementById('errorMsg');
        
        // Show Loading
        loader.style.display = 'block';
        errBox.style.display = 'none';

        // Call your Apps Script to check if this email is "Pending" in the sheet
        fetch(SCRIPT_URL, {
            method: 'POST',
            redirect: "follow",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "login", email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.allowed === true) {
                // SUCCESS: Save to LocalStorage and Redirect
                localStorage.setItem('userEmail', email);
                localStorage.setItem('authValid', 'true');
                window.location.href = 'index.html';
            } else {
                // FAILED: Show error from Sheet (e.g., "Access Denied" or "Used")
                loader.style.display = 'none';
                throw new Error(data.message || "Access Denied.");
            }
        })
        .catch(error => {
            console.error("Login Error:", error);
            loader.style.display = 'none';
            errBox.innerText = "Error: " + (error.message || "Connection failed.");
            errBox.style.display = 'block';
        });
    }
</script>
</body>
</html>
