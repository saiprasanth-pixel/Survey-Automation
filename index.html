<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Setup - Page 1</title>
    <script>
        const userEmail = localStorage.getItem('userEmail');
        if (!localStorage.getItem('authValid') || !userEmail) {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root { --primary: #4F46E5; --primary-hover: #4338ca; --bg-color: #F3F4F6; --card-bg: #ffffff; --text-dark: #1F2937; --text-light: #6B7280; --border: #E5E7EB; --danger: #ef4444; }
        * { box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); margin: 0; padding: 40px 20px; color: var(--text-dark); }
        .container { max-width: 900px; margin: 0 auto; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .header { background: var(--primary); color: white; padding: 25px 40px; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0; }
        .header h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .step-indicator { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 14px; }
        form { padding: 40px; }
        .section-title { font-size: 18px; font-weight: 700; color: var(--text-dark); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border); margin-top: 30px; }
        .section-title:first-of-type { margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-light); text-transform: uppercase; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; color: var(--text-dark); background: #fff; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        input.error, select.error { border-color: var(--danger); background-color: #fef2f2; }
        .multiselect { width: 100%; position: relative; }
        .selectBox { position: relative; cursor: pointer; }
        .selectBox select { width: 100%; font-weight: bold; cursor: pointer; }
        .overSelect { position: absolute; left: 0; right: 0; top: 0; bottom: 0; }
        #checkboxes { display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 10; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #checkboxes label { display: flex; align-items: center; padding: 8px 12px; margin: 0; font-weight: normal; font-size: 14px; color: var(--text-dark); cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        #checkboxes label:hover { background-color: #f3f4f6; }
        #checkboxes label input { width: auto; margin-right: 10px; margin-top: 0; }
        .custom-wrapper { display: none; margin-top: 10px; padding: 15px; background: #f9fafb; border: 1px dashed var(--border); border-radius: 6px; }
        .creative-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .creative-table th, .creative-table td { border: 1px solid var(--border); padding: 12px; text-align: left; vertical-align: middle; }
        .creative-table th { background-color: #f9fafb; font-size: 13px; color: var(--text-light); }
        .btn-add-creative { background: #eef2ff; color: var(--primary); border: 1px dashed var(--primary); padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 13px; font-weight: 600; width: 100%; }
        .btn-del-creative { background: #fee2e2; color: var(--danger); border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .form-footer { margin-top: 40px; display: flex; justify-content: space-between; align-items: center; }
        .next-btn { background-color: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .next-btn:hover { background-color: var(--primary-hover); }
        .draft-text { color: var(--text-light); font-size: 12px; font-style: italic; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
        .user-bar { background: #312e81; color: white; padding: 5px 20px; font-size: 12px; text-align: right; display: flex; justify-content: space-between; }
        .user-bar a { color: #a5b4fc; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="user-bar">
    <div id="savingIndicator" style="display:none;">Saving draft...</div>
    <div>Logged in as: <span id="userDisplay">...</span> <a onclick="logout()">[Logout]</a></div>
</div>

<div class="container">
    <div class="header">
        <h1>Campaign Request Form</h1>
        <div class="step-indicator">Page 1 of 2</div>
    </div>

    <form id="page1Form" novalidate oninput="autoSave()">
        <div class="section-title">General Information</div>
        <div class="form-grid">
            <div class="form-group"><label>Name of the Survey</label><input type="text" id="surveyName" placeholder="e.g. Aspirations Survey" required></div>
            <div class="form-group"><label>Survey Start Date</label><input type="date" id="surveyDate" required></div>
            <div class="form-group"><label>Approval By</label><select id="approvalBy" required><option value="" disabled selected>Select Approver</option><option value="Ishan Sharma">Ishan Sharma</option><option value="Manager B">Manager B</option></select></div>
            <div class="form-group"><label>POC Name</label><input type="text" id="pocName" placeholder="Enter POC Name" required></div>
            <div class="form-group"><label>POC Email</label><input type="email" id="pocEmail" placeholder="Enter POC Email" required></div>
            <div class="form-group"><label>Overall Budget</label><input type="number" id="overallBudget" placeholder="Enter Amount" required min="1"></div>
        </div>

        <div class="section-title">Location Targeting</div>
        <div class="form-grid">
            <div class="full-width"><small style="color: #ef4444; font-weight: bold;">* Fill Only 1: Either Location OR Pincodes</small></div>
            <div class="form-group"><label>Number of Target Locations</label><input type="number" id="locCount" value="1" required min="1"></div>
            <div class="form-group"><label>Name of Location(s)</label><input type="text" id="locName" placeholder="e.g. Hyderabad, Khammam"><small style="color:#666; font-size:11px;">Separate with commas</small></div>
            <div class="form-group full-width"><label>Pincodes</label><input type="text" id="locPin" placeholder="e.g. 500081, 500032"></div>
        </div>

        <div class="section-title">Demographics</div>
        <div class="form-grid">
            <div class="form-group full-width">
                <label>Specific Age Targeting?</label>
                <select id="ageTargetSelect" onchange="toggleAgeInput(); autoSave();"><option value="No" selected>No (General 18-65+)</option><option value="Yes">Yes</option></select>
                <div id="customAgeInput" class="custom-wrapper"><label style="color: #4F46E5;">Enter Custom Age Ranges</label><input type="text" id="customAgeText" placeholder="e.g. 18-24, 35-60"></div>
            </div>
            <div class="form-group full-width">
                <label>Gender Targeting</label>
                <select id="genderSelect" onchange="toggleGenderInputs(); autoSave();"><option value="All" selected>All Genders</option><option value="Male">Male Only</option><option value="Female">Female Only</option></select>
            </div>
            <div class="form-group" id="maleTargetWrapper"><label>Male Target Number</label><input type="number" id="maleTargetNum" placeholder="e.g. 5000"></div>
            <div class="form-group" id="femaleTargetWrapper"><label>Female Target Number</label><input type="number" id="femaleTargetNum" placeholder="e.g. 5000"></div>
            <div class="form-group full-width">
                <label>Targeting Language (Max 3)</label>
                <div class="multiselect">
                    <div class="selectBox" onclick="showCheckboxes()"><select><option id="languageDisplayText">Select Languages</option></select><div class="overSelect"></div></div>
                    <div id="checkboxes">
                        <label><input type="checkbox" value="Telugu" onchange="updateLanguageDisplay(this); autoSave()"> Telugu</label>
                        <label><input type="checkbox" value="Hindi" onchange="updateLanguageDisplay(this); autoSave()"> Hindi</label>
                        <label><input type="checkbox" value="Tamil" onchange="updateLanguageDisplay(this); autoSave()"> Tamil</label>
                        <label><input type="checkbox" value="English" onchange="updateLanguageDisplay(this); autoSave()"> English</label>
                        <label><input type="checkbox" value="Kannada" onchange="updateLanguageDisplay(this); autoSave()"> Kannada</label>
                        <label><input type="checkbox" value="Malayalam" onchange="updateLanguageDisplay(this); autoSave()"> Malayalam</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-title">Creative Links (Max 3)</div>
        <div class="full-width">
            <table class="creative-table">
                <thead><tr><th style="width:50px;">S.No</th><th>Creative Link Name</th><th>Image URL</th><th style="width:60px;">Action</th></tr></thead>
                <tbody id="creativeBody">
                    <tr><td>1</td><td><input type="text" class="c-name" placeholder="Enter Name"></td><td><input type="text" class="c-url" placeholder="Paste URL here"></td><td></td></tr>
                </tbody>
            </table>
            <button type="button" class="btn-add-creative" onclick="addCreativeRow()">+ Add Creative View</button>
        </div>

        <div class="form-footer">
            <div class="draft-text" id="draftStatus">Auto-saving enabled</div>
            <button type="button" class="next-btn" onclick="goToPage2()">Next Page &rarr;</button>
        </div>
    </form>
</div>

<script>
    // --- 2. CONFIGURATION ---
    const SCRIPT_URL = 'PASTE_YOUR_APPS_SCRIPT_URL_HERE'; // <--- PASTE YOUR URL HERE

    document.getElementById('userDisplay').innerText = localStorage.getItem('userEmail');
    
    // --- 3. INIT & SECURITY CHECK ---
    window.onload = function() {
        // A. Security: Re-verify access with server to ensure they aren't "Used"
        verifyStatusOnLoad();

        // B. Load UI Defaults
        toggleGenderInputs();
        toggleAgeInput(); 

        // C. Load Draft
        loadDraft(); 
    };

    function verifyStatusOnLoad() {
        const email = localStorage.getItem('userEmail');
        // Silent Fetch
        fetch(SCRIPT_URL, {
            method: 'POST',
            redirect: "follow",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "checkStatus", email: email })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.allowed) {
                // If server says "Used" or "Pending" is gone, kick them out
                alert("Access Revoked: " + data.message);
                logout();
            }
        })
        .catch(err => console.log("Background check failed, proceeding offline..."));
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // --- UI LOGIC ---
    function toggleGenderInputs() {
        const val = document.getElementById("genderSelect").value;
        const maleDiv = document.getElementById("maleTargetWrapper");
        const femaleDiv = document.getElementById("femaleTargetWrapper");
        if (val === "All") { maleDiv.style.display = "block"; femaleDiv.style.display = "block"; }
        else if (val === "Male") { maleDiv.style.display = "block"; femaleDiv.style.display = "none"; }
        else if (val === "Female") { maleDiv.style.display = "none"; femaleDiv.style.display = "block"; }
    }
    
    function toggleAgeInput() {
        const val = document.getElementById("ageTargetSelect").value;
        document.getElementById("customAgeInput").style.display = (val === "Yes") ? "block" : "none";
    }

    function addCreativeRow() {
        const tbody = document.getElementById("creativeBody");
        if (tbody.children.length >= 3) { alert("Maximum 3 creative views allowed."); return; }
        const count = tbody.children.length + 1;
        const row = `<tr>
            <td>${count}</td>
            <td><input type="text" class="c-name" placeholder="Enter Name"></td>
            <td><input type="text" class="c-url" placeholder="Paste URL here"></td>
            <td><button type="button" class="btn-del-creative" onclick="deleteCreativeRow(this)">Del</button></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
        renumberCreatives();
        autoSave();
    }
    function deleteCreativeRow(btn) { btn.closest('tr').remove(); renumberCreatives(); autoSave(); }
    function renumberCreatives() { document.querySelectorAll('#creativeBody tr').forEach((row, i) => row.cells[0].innerText = i + 1); }

    var expanded = false;
    function showCheckboxes() {
        const checkboxes = document.getElementById("checkboxes");
        checkboxes.style.display = expanded ? "none" : "block";
        expanded = !expanded;
    }
    function updateLanguageDisplay(checkbox) {
        const checkboxes = document.querySelectorAll('#checkboxes input[type="checkbox"]');
        let selected = [];
        checkboxes.forEach(cb => { if(cb.checked) selected.push(cb.value); });
        if (selected.length > 3) { alert("Max 3 languages allowed."); checkbox.checked = false; return; }
        document.getElementById("languageDisplayText").textContent = selected.length ? selected.join(', ') : "Select Languages";
    }

    // --- AUTO SAVE & DRAFT LOGIC ---
    let saveTimeout;
    function autoSave() {
        clearTimeout(saveTimeout);
        document.getElementById('draftStatus').innerText = "Saving...";
        saveTimeout = setTimeout(() => {
            const data = gatherFormData();
            localStorage.setItem('page1Draft', JSON.stringify(data));
            document.getElementById('draftStatus').innerText = "Draft Saved";
        }, 1000); // Save 1 second after typing stops
    }

    function gatherFormData() {
        let creatives = [];
        document.querySelectorAll('#creativeBody tr').forEach(row => {
            creatives.push({ name: row.querySelector('.c-name').value, url: row.querySelector('.c-url').value });
        });
        let langs = [];
        document.querySelectorAll('#checkboxes input:checked').forEach(cb => langs.push(cb.value));

        return {
            surveyName: document.getElementById("surveyName").value,
            surveyDate: document.getElementById("surveyDate").value,
            approvalBy: document.getElementById("approvalBy").value,
            pocName: document.getElementById("pocName").value,
            pocEmail: document.getElementById("pocEmail").value,
            budget: document.getElementById("overallBudget").value,
            locCount: document.getElementById("locCount").value,
            locName: document.getElementById("locName").value,
            locPin: document.getElementById("locPin").value,
            ageTarget: document.getElementById("ageTargetSelect").value,
            customAge: document.getElementById("customAgeText").value,
            gender: document.getElementById("genderSelect").value,
            maleCount: document.getElementById("maleTargetNum").value,
            femaleCount: document.getElementById("femaleTargetNum").value,
            languages: langs,
            creatives: creatives
        };
    }

    function loadDraft() {
        const saved = localStorage.getItem('page1Draft');
        if (!saved) return;
        
        try {
            const data = JSON.parse(saved);
            
            // 1. Simple Fields
            const fields = ["surveyName", "surveyDate", "approvalBy", "pocName", "pocEmail", "overallBudget", "locCount", "locName", "locPin", "customAge", "maleTargetNum", "femaleTargetNum"];
            fields.forEach(id => { if(data[id]) document.getElementById(id).value = data[id]; });

            // 2. Dropdowns & Toggles
            if(data.ageTarget) { document.getElementById("ageTargetSelect").value = data.ageTarget; toggleAgeInput(); }
            if(data.gender) { document.getElementById("genderSelect").value = data.gender; toggleGenderInputs(); }

            // 3. Languages
            if (data.languages) {
                const boxes = document.querySelectorAll('#checkboxes input');
                let hasLangs = false;
                boxes.forEach(cb => {
                    if(data.languages.includes(cb.value)) { cb.checked = true; hasLangs = true; }
                });
                if(hasLangs) updateLanguageDisplay({checked:true});
            }

            // 4. Creatives (Rebuild Table)
            if (data.creatives && data.creatives.length > 0) {
                const tbody = document.getElementById("creativeBody");
                tbody.innerHTML = ''; // Wipe and rebuild
                data.creatives.forEach((c, index) => {
                    const row = `<tr>
                        <td>${index+1}</td>
                        <td><input type="text" class="c-name" value="${c.name}"></td>
                        <td><input type="text" class="c-url" value="${c.url}"></td>
                        <td>${index > 0 ? '<button type="button" class="btn-del-creative" onclick="deleteCreativeRow(this)">Del</button>' : ''}</td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }
            document.getElementById('draftStatus').innerText = "Draft Restored";
        } catch(e) { console.error("Draft load error", e); }
    }

    function validateEmail(email) {
        return String(email).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
    }

    function goToPage2() {
        // Validation (Abbreviated for brevity - logic remains same as before)
        if(!document.getElementById("surveyName").value) { alert("Please fill the form"); return; }
        
        const data = gatherFormData();
        localStorage.setItem('surveyData', JSON.stringify(data));
        // Force save draft on exit
        localStorage.setItem('page1Draft', JSON.stringify(data));
        window.location.href = 'page2.html';
    }
</script>
</body>
</html>
